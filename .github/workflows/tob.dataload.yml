name: CMM Dataload

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 1 * * *'

env:
  TESSDATA_PREFIX: /usr/share/tesseract-ocr/4.00/tessdata/
  CHROMEDRIVER_VERSION: 115.0.5790.170

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        repository: s2pl/TrainOnBoarding_BE
        token: ${{ secrets.PERSONAL_TOKEN }}
    
    - name: Setup environment
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip tesseract-ocr

        pip3 install selenium pytesseract pillow pandas django

        mkdir -p $HOME/drivers
        cd $HOME/drivers

        # Download and set up ChromeDriver
        wget "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/120.0.6099.71/linux64/chromedriver-linux64.zip"
        unzip chromedriver-linux64.zip
        chmod +x chromedriver-linux64/chromedriver
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/

        # Download and set up geckodriver (optional)
        wget https://github.com/mozilla/geckodriver/releases/download/v0.33.0/geckodriver-v0.33.0-linux64.tar.gz
        tar -xzf geckodriver-v0.33.0-linux64.tar.gz
        chmod +x geckodriver
        sudo mv geckodriver /usr/local/bin/

    # - name: Install Requirements
    #   id: trainOnBoardingRequirementsInstallation
    #   run: pip3 install -r requirements.txt
    - name: Create secrets.json
      run: |
        echo -e "{"DATABASES_PROD":{"default":{"ENGINE":"django.db.backends.postgresql","NAME":"deleted","USER":"deleted","PASSWORD":"deleted","HOST":"deleted","PORT":"deleted"}},"DATABASES_LOCAL":{"default":{"ENGINE":"django.db.backends.sqlite3","NAME":"db.sqlite3"}},"GMAIL_LOCAL":{"GMAIL_USER":"deleted","GMAIL_PASSWORD":"deleted"},"GMAIL_PROD":{"GMAIL_USER":"deleted","GMAIL_PASSWORD":"deleted"},"TWILIO_LOCAL":{"ACCOUNT_SID":"deleted","AUTH_TOKEN":"deleted","FROM_MOBILE":"+deleted"},"TWILIO_PROD":{"ACCOUNT_SID":"deleted","AUTH_TOKEN":"deleted","FROM_MOBILE":"+deleted"},"AWS_LOCAL":{"AWS_ACCESS_KEY_ID":"deleted","AWS_SECRET_ACCESS_KEY":"deleted","AWS_STORAGE_BUCKET_NAME":"deleted","AWS_DEFAULT_ACL":null,"AWS_S3_CUSTOM_DOMAIN":"bucket.s3.amazonaws.com","AWS_S3_OBJECT_PARAMETERS":{"CacheControl":"max-age=86400"}},"AWS_PROD":{"AWS_ACCESS_KEY_ID":"deleted","AWS_SECRET_ACCESS_KEY":"deleted+deleted","AWS_STORAGE_BUCKET_NAME":"deleted","AWS_DEFAULT_ACL":null,"AWS_S3_CUSTOM_DOMAIN":"deleted.s3.amazonaws.com","AWS_S3_OBJECT_PARAMETERS":{"CacheControl":"max-age=86400"}},"2FA_AUTH_LOCAL":{"api_key":"deleted"},"2FA_AUTH_PROD":{"api_key":"deleted"},"GOOGLE":{"CLIENT_ID":"deleted","CLIENT_SECRET":"deleted"},"DRIVE":{"SERVICE_ACCOUNT_FILE_NAME":"sa.json","CMM__DRIVE_FOLDER_ID":"deleted","RAILMADAD__DRIVE_FOLDER_ID":"deleted"}}" > train_api/secretes.json
        echo -e "{"DATABASES_PROD":{"default":{"ENGINE":"django.db.backends.postgresql","NAME":"deleted","USER":"deleted","PASSWORD":"deleted","HOST":"deleted","PORT":"deleted"}},"DATABASES_LOCAL":{"default":{"ENGINE":"django.db.backends.sqlite3","NAME":"db.sqlite3"}},"GMAIL_LOCAL":{"GMAIL_USER":"deleted","GMAIL_PASSWORD":"deleted"},"GMAIL_PROD":{"GMAIL_USER":"deleted","GMAIL_PASSWORD":"deleted"},"TWILIO_LOCAL":{"ACCOUNT_SID":"deleted","AUTH_TOKEN":"deleted","FROM_MOBILE":"+deleted"},"TWILIO_PROD":{"ACCOUNT_SID":"deleted","AUTH_TOKEN":"deleted","FROM_MOBILE":"+deleted"},"AWS_LOCAL":{"AWS_ACCESS_KEY_ID":"deleted","AWS_SECRET_ACCESS_KEY":"deleted","AWS_STORAGE_BUCKET_NAME":"deleted","AWS_DEFAULT_ACL":null,"AWS_S3_CUSTOM_DOMAIN":"bucket.s3.amazonaws.com","AWS_S3_OBJECT_PARAMETERS":{"CacheControl":"max-age=86400"}},"AWS_PROD":{"AWS_ACCESS_KEY_ID":"deleted","AWS_SECRET_ACCESS_KEY":"deleted+deleted","AWS_STORAGE_BUCKET_NAME":"deleted","AWS_DEFAULT_ACL":null,"AWS_S3_CUSTOM_DOMAIN":"deleted.s3.amazonaws.com","AWS_S3_OBJECT_PARAMETERS":{"CacheControl":"max-age=86400"}},"2FA_AUTH_LOCAL":{"api_key":"deleted"},"2FA_AUTH_PROD":{"api_key":"deleted"},"GOOGLE":{"CLIENT_ID":"deleted","CLIENT_SECRET":"deleted"},"DRIVE":{"SERVICE_ACCOUNT_FILE_NAME":"sa.json","CMM__DRIVE_FOLDER_ID":"deleted","RAILMADAD__DRIVE_FOLDER_ID":"deleted"}}" > secretes.json

    - name: Run automation.py
      id: trainOnBoardingAutomation
      run: python train_api/automation.py
